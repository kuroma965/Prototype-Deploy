<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/img/logo.png" />

    <!-- global stylesheet (single source of truth) -->
  <link rel="stylesheet" href="/global.css" />

  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

  <!-- default title (สามารถถูกแทนได้หลังโหลด) -->
  <title>Prototype</title>

  <!-- ตัวอย่าง: สคริปต์ที่ต้องการรันจาก head (เช่น SweetAlert) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

  <!-- เพิ่ม meta, theme-color, manifest ฯลฯ ตามต้องการ -->
  <meta name="theme-color" content="#007bff" />
</head>

<body>
  <!-- WRAPPER that stretches to push footer down -->
  <main class="site-main">
    <div class="card form-card" role="main" aria-labelledby="page-title">
      <a href="/index.html" class="back">← กลับหน้าหลัก</a>

      <h1 id="page-title">ฟอร์มส่งอีเมล (Maileroo)</h1>
      <p class="lead">กรอกข้อมูลแล้วกดส่ง — หาก JavaScript ปิด หน้าเว็บจะ fallback เป็น submit ปกติ</p>

      <form id="maileroo-form" method="POST" action="/api/send-mail-maileroo" novalidate>
        <label for="to">อีเมลผู้รับ</label>
        <input type="email" id="to" name="to" placeholder="someone@example.com" required />

        <label for="subject">หัวข้อ</label>
        <input type="text" id="subject" name="subject" placeholder="หัวข้ออีเมล" required />

        <label for="message">ข้อความ</label>
        <textarea id="message" name="message" placeholder="พิมพ์ข้อความที่ต้องการส่ง" required></textarea>

        <button id="submit-btn" type="submit" class="btn primary">ส่งอีเมลผ่าน Maileroo</button>
      </form>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo" aria-label="Footer">
    <div class="inner">
      <a class="gh-link" href="https://github.com/reqiler/Prototype" target="_blank" rel="noopener noreferrer"
        title="Open GitHub repo: reqiler/Prototype">
        <!-- GitHub Mark (SVG) -->
        <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img"
          width="18" height="18">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
        0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01
        1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95
        0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.6 7.6 0 0 1 2.01-.27c.68.003
        1.36.092 2.01.27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15
        0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013
        8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
        </svg>

        <span>reqiler / Prototype</span>
      </a>

      <div class="meta" aria-hidden="true">
        &nbsp;•&nbsp; ดูบน GitHub
      </div>
    </div>

    <!-- append current year (inline script — จะ execute ปกติเพราะเป็นโค้ดในหน้า) -->
    <script>
      (function () {
        try {
          const inner = document.querySelector('.site-footer .inner');
          if (inner) {
            const span = document.createElement('div');
            span.className = 'meta';
            span.style.marginLeft = '6px';
            span.textContent = '© ' + new Date().getFullYear() + ' reqiler';
            inner.appendChild(span);
          }
        } catch (e) {
          // ignore
          console.error(e);
        }
      })();
    </script>
  </footer>


  <!-- Form binding script: waits for __headLoaded (so SweetAlert is available) -->
  <script>
    (async function () {
      // wait until shared head/layout (and SweetAlert) are loaded
      if (window.__headLoaded) await window.__headLoaded;

      const form = document.getElementById('maileroo-form');
      const submitBtn = document.getElementById('submit-btn');
      if (!form) return;

      function showLoading() {
        if (window.Swal && Swal.fire) {
          Swal.fire({ title: 'กำลังส่ง...', html: 'โปรดรอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        }
      }
      function showSuccess(message = 'ส่งอีเมลสำเร็จ') {
        if (window.Swal && Swal.fire) {
          Swal.fire({ icon: 'success', title: 'สำเร็จ', html: message, confirmButtonText: 'ตกลง' });
        } else {
          alert(message);
        }
      }
      function showError(title = 'เกิดข้อผิดพลาด', message = '') {
        if (window.Swal && Swal.fire) {
          Swal.fire({ icon: 'error', title: title, html: message || '', confirmButtonText: 'ตกลง' });
        } else {
          alert((title ? title + '\n' : '') + (message || ''));
        }
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const to = form.to.value.trim();
        const subject = form.subject.value.trim();
        const message = form.message.value.trim();

        if (!to || !subject || !message) {
          showError('ข้อมูลไม่ครบ', 'กรุณากรอก to, subject, message ให้ครบ');
          return;
        }

        const payload = new FormData(form);

        try {
          submitBtn.disabled = true;
          showLoading();

          const res = await fetch(form.action || '/api/send-mail-maileroo', {
            method: (form.method || 'POST').toUpperCase(),
            body: payload,
            credentials: 'same-origin'
          });

          // Try parse json response (the API was adjusted to return JSON)
          let data = null;
          try { data = await res.json(); } catch (err) { data = null; }

          if (res.ok) {
            // Expect { success: true, to: ..., maileroo: {...} }
            const msg = (data && (data.message || (data.success ? `ส่งไปที่ ${to}` : null))) || `ส่งไปที่ ${to}`;
            if (window.Swal && Swal.close) Swal.close();
            showSuccess(msg);
            form.reset();
          } else {
            // Non-OK: show details if available
            const detail = (data && (data.detail || JSON.stringify(data))) || `${res.status} ${res.statusText}`;
            if (window.Swal && Swal.close) Swal.close();
            showError('Maileroo ส่งไม่สำเร็จ', detail);
            console.error('Maileroo API error', res.status, data);
          }
        } catch (err) {
          if (window.Swal && Swal.close) Swal.close();
          console.error('Request failed', err);
          showError('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', err instanceof Error ? err.message : String(err));
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>

</html>