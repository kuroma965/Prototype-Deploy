<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ส่งเมลผ่าน Maileroo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ensure CSS loads -->
  <link rel="stylesheet" href="/global.css" />

  <!-- head loader (load shared layout/head which should include SweetAlert) -->
  <script>
    (function () {
      async function loadHeadComponent(url, opts = {}) {
        try {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error('Failed to load head component: ' + res.status);
          const text = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const headNodes = Array.from(doc.head.childNodes).filter(n => n.nodeType === 1);
          for (const node of headNodes) {
            if (node.tagName && node.tagName.toLowerCase() === 'script') {
              const s = document.createElement('script');
              for (const attr of node.attributes) s.setAttribute(attr.name, attr.value);
              if (!node.src) s.textContent = node.textContent;
              document.head.appendChild(s);
              if (s.src) {
                await new Promise((resolve) => {
                  s.addEventListener('load', resolve);
                  s.addEventListener('error', () => { console.warn('Script failed to load:', s.src); resolve(); });
                });
              }
            } else {
              document.head.appendChild(node.cloneNode(true));
            }
          }
          if (opts && opts.title) document.title = opts.title;
        } catch (err) {
          console.error(err);
        }
      }
      // adjust path to your layout component if needed
      window.__headLoaded = loadHeadComponent('/layout/layout.html');
    })();
  </script>
</head>

<body>
  <!-- WRAPPER that stretches to push footer down -->
  <main class="site-main">
    <div class="card form-card" role="main" aria-labelledby="page-title">
      <a href="/index.html" class="back">← กลับหน้าหลัก</a>

      <h1 id="page-title">ฟอร์มส่งอีเมล (Maileroo)</h1>
      <p class="lead">กรอกข้อมูลแล้วกดส่ง — หาก JavaScript ปิด หน้าเว็บจะ fallback เป็น submit ปกติ</p>

      <form id="maileroo-form" method="POST" action="/api/send-mail-maileroo" novalidate>
        <label for="to">อีเมลผู้รับ</label>
        <input type="email" id="to" name="to" placeholder="someone@example.com" required />

        <label for="subject">หัวข้อ</label>
        <input type="text" id="subject" name="subject" placeholder="หัวข้ออีเมล" required />

        <label for="message">ข้อความ</label>
        <textarea id="message" name="message" placeholder="พิมพ์ข้อความที่ต้องการส่ง" required></textarea>

        <button id="submit-btn" type="submit" class="btn primary">ส่งอีเมลผ่าน Maileroo</button>
      </form>
    </div>
  </main>

  <!-- Form binding script: waits for __headLoaded (so SweetAlert is available) -->
  <script>
    (async function () {
      // wait until shared head/layout (and SweetAlert) are loaded
      if (window.__headLoaded) await window.__headLoaded;

      const form = document.getElementById('maileroo-form');
      const submitBtn = document.getElementById('submit-btn');
      if (!form) return;

      function showLoading() {
        if (window.Swal && Swal.fire) {
          Swal.fire({ title: 'กำลังส่ง...', html: 'โปรดรอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        }
      }
      function showSuccess(message = 'ส่งอีเมลสำเร็จ') {
        if (window.Swal && Swal.fire) {
          Swal.fire({ icon: 'success', title: 'สำเร็จ', html: message, confirmButtonText: 'ตกลง' });
        } else {
          alert(message);
        }
      }
      function showError(title = 'เกิดข้อผิดพลาด', message = '') {
        if (window.Swal && Swal.fire) {
          Swal.fire({ icon: 'error', title: title, html: message || '', confirmButtonText: 'ตกลง' });
        } else {
          alert((title ? title + '\n' : '') + (message || ''));
        }
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const to = form.to.value.trim();
        const subject = form.subject.value.trim();
        const message = form.message.value.trim();

        if (!to || !subject || !message) {
          showError('ข้อมูลไม่ครบ', 'กรุณากรอก to, subject, message ให้ครบ');
          return;
        }

        const payload = new FormData(form);

        try {
          submitBtn.disabled = true;
          showLoading();

          const res = await fetch(form.action || '/api/send-mail-maileroo', {
            method: (form.method || 'POST').toUpperCase(),
            body: payload,
            credentials: 'same-origin'
          });

          // Try parse json response (the API was adjusted to return JSON)
          let data = null;
          try { data = await res.json(); } catch (err) { data = null; }

          if (res.ok) {
            // Expect { success: true, to: ..., maileroo: {...} }
            const msg = (data && (data.message || (data.success ? `ส่งไปที่ ${to}` : null))) || `ส่งไปที่ ${to}`;
            if (window.Swal && Swal.close) Swal.close();
            showSuccess(msg);
            form.reset();
          } else {
            // Non-OK: show details if available
            const detail = (data && (data.detail || JSON.stringify(data))) || `${res.status} ${res.statusText}`;
            if (window.Swal && Swal.close) Swal.close();
            showError('Maileroo ส่งไม่สำเร็จ', detail);
            console.error('Maileroo API error', res.status, data);
          }
        } catch (err) {
          if (window.Swal && Swal.close) Swal.close();
          console.error('Request failed', err);
          showError('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', err instanceof Error ? err.message : String(err));
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>

  <!-- Footer loader: load /components/footer.html and execute inline scripts properly -->
  <script>
    (async function () {
      try {
        const res = await fetch('/components/footer.html', { cache: 'no-cache' });
        if (!res.ok) return console.warn('Could not load footer:', res.status);

        const text = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');

        const footer = doc.body.querySelector('footer.site-footer');
        if (!footer) {
          // fallback: insert raw HTML
          document.body.insertAdjacentHTML('beforeend', text);
          return;
        }

        // extract scripts from footer to execute them explicitly
        const scripts = Array.from(footer.querySelectorAll('script'));
        scripts.forEach(s => s.parentNode && s.parentNode.removeChild(s));

        // append footer DOM
        document.body.appendChild(footer);

        // recreate and append scripts so they execute
        for (const s of scripts) {
          const newS = document.createElement('script');
          for (const a of s.attributes) newS.setAttribute(a.name, a.value);
          if (s.src) {
            // external script
            newS.src = s.src;
            // preserve async/defer attributes if present
            if (s.async) newS.async = true;
            if (s.defer) newS.defer = true;
            footer.appendChild(newS);
            // Note: if you need to wait for these scripts, you can await load events
          } else {
            newS.textContent = s.textContent;
            footer.appendChild(newS);
          }
        }
      } catch (err) {
        console.error('Footer load error', err);
      }
    })();
  </script>
</body>
</html>
