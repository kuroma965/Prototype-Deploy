<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/img/logo.png" />

    <!-- global stylesheet (single source of truth) -->
  <link rel="stylesheet" href="/global.css" />

  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

  <!-- default title (สามารถถูกแทนได้หลังโหลด) -->
  <title>Prototype</title>

  <!-- ตัวอย่าง: สคริปต์ที่ต้องการรันจาก head (เช่น SweetAlert) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

  <!-- เพิ่ม meta, theme-color, manifest ฯลฯ ตามต้องการ -->
  <meta name="theme-color" content="#007bff" />
</head>

<body>
  <!-- main wrapper stretches to push footer down -->
  <main class="site-main">
    <div class="card wrap" role="main" aria-labelledby="page-title">
      <a href="/index.html" class="back" aria-label="กลับหน้าหลัก">← กลับหน้าหลัก</a>
      <h2 id="page-title">Upload (client → your server → pic.in.th)</h2>

      <label for="fileInput" style="display:block; margin-top:12px; font-weight:600;">เลือกไฟล์รูป</label>
      <input type="file" id="fileInput" accept="image/*" aria-describedby="upload-help" />

      <div id="selected-info" style="margin-top:8px; color:var(--text-muted); font-size:0.95rem;"></div>

      <button class="btn" id="uploadBtn" style="margin-top:10px;" disabled>Upload</button>

      <div id="status" style="margin-top:12px;" role="status" aria-live="polite"></div>

      <!-- preview area (will show before upload and replaced with server image after upload) -->
      <div id="preview" style="margin-top:12px; "></div>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo" aria-label="Footer">
    <div class="inner">
      <a class="gh-link" href="https://github.com/reqiler/Prototype" target="_blank" rel="noopener noreferrer"
        title="Open GitHub repo: reqiler/Prototype">
        <!-- GitHub Mark (SVG) -->
        <svg aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img"
          width="18" height="18">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
        0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01
        1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95
        0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.6 7.6 0 0 1 2.01-.27c.68.003
        1.36.092 2.01.27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15
        0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013
        8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
        </svg>

        <span>reqiler / Prototype</span>
      </a>

      <div class="meta" aria-hidden="true">
        &nbsp;•&nbsp; ดูบน GitHub
      </div>
    </div>

    <!-- append current year (inline script — จะ execute ปกติเพราะเป็นโค้ดในหน้า) -->
    <script>
      (function () {
        try {
          const inner = document.querySelector('.site-footer .inner');
          if (inner) {
            const span = document.createElement('div');
            span.className = 'meta';
            span.style.marginLeft = '6px';
            span.textContent = '© ' + new Date().getFullYear() + ' reqiler';
            inner.appendChild(span);
          }
        } catch (e) {
          // ignore
          console.error(e);
        }
      })();
    </script>
  </footer>


  <!-- upload + preview + footer loader -->
  <script>
    (async function () {
      // wait for shared head (SweetAlert etc.) to be available if used
      if (window.__headLoaded) await window.__headLoaded;

      const input = document.getElementById('fileInput');
      const selectedInfo = document.getElementById('selected-info');
      const status = document.getElementById('status');
      const preview = document.getElementById('preview');
      const uploadBtn = document.getElementById('uploadBtn');

      let objectUrl = null;

      function showSwalError(title, text) {
        if (window.Swal) {
          Swal.fire({ icon: 'error', title: title || 'เกิดข้อผิดพลาด', text: text || '' });
        } else {
          alert((title ? title + '\n' : '') + (text || ''));
        }
      }

      function showSwalSuccess(title, html) {
        if (window.Swal) {
          Swal.fire({ icon: 'success', title: title || 'สำเร็จ', html: html || '' });
        } else {
          alert(title || 'สำเร็จ');
        }
      }

      function renderLocalPreview(file) {
        // clean previous
        preview.innerHTML = '';
        if (objectUrl) {
          URL.revokeObjectURL(objectUrl);
          objectUrl = null;
        }

        if (!file) return;

        const info = document.createElement('div');
        info.textContent = `${file.name} — ${(file.size / 1024).toFixed(1)} KB`;
        info.style.marginBottom = '8px';
        selectedInfo.textContent = '';
        selectedInfo.appendChild(info);

        // Create image preview (use object URL for best performance)
        objectUrl = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = objectUrl;
        img.alt = 'preview';
        img.className = 'preview';
        img.style.maxWidth = '320px';
        img.style.borderRadius = '6px';
        img.style.display = 'block';
        preview.appendChild(img);

        // enable upload button
        uploadBtn.disabled = false;
      }

      input.addEventListener('change', (e) => {
        status.textContent = '';
        preview.innerHTML = '';
        selectedInfo.textContent = '';

        const file = input.files && input.files[0];
        if (!file) {
          uploadBtn.disabled = true;
          return;
        }

        // check type
        if (!file.type.startsWith('image/')) {
          showSwalError('ไฟล์ไม่ถูกต้อง', 'โปรดเลือกไฟล์รูป (jpg, png, gif, ...)');
          input.value = '';
          uploadBtn.disabled = true;
          return;
        }

        // file size check (10MB)
        if (file.size > 10 * 1024 * 1024) {
          showSwalError('ไฟล์ใหญ่เกิน', 'ไฟล์ต้องมีขนาดไม่เกิน 10 MB');
          input.value = '';
          uploadBtn.disabled = true;
          return;
        }

        renderLocalPreview(file);
      });

      uploadBtn.addEventListener('click', async () => {
        const file = input.files && input.files[0];
        if (!file) {
          showSwalError('ไม่พบไฟล์', 'โปรดเลือกไฟล์ก่อนอัพโหลด');
          return;
        }

        uploadBtn.disabled = true;
        status.textContent = 'กำลังอัพโหลดไปยังเซิร์ฟเวอร์ของคุณ...';

        try {
          const fd = new FormData();
          fd.append('file', file);

          const res = await fetch('/api/upload', { method: 'POST', body: fd });
          let json = null;
          try { json = await res.json(); } catch (e) { json = null; }

          if (!res.ok) {
            const errMsg = json && (json.error || json.detail) ? JSON.stringify(json) : res.statusText;
            status.textContent = 'Upload failed: ' + errMsg;
            console.error('upload failed', res.status, json);
            showSwalError('อัพโหลดล้มเหลว', errMsg);
            uploadBtn.disabled = false;
            return;
          }

          // success
          const image = json?.image;
          const localPath = json?.local_path;
          const url = image?.display_url || image?.url || null;

          // Update preview area: prefer using server URL (if provided)
          preview.innerHTML = '';
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener';
            a.style.display = 'inline-block';
            a.style.marginBottom = '8px';

            const img = document.createElement('img');
            img.src = url;
            img.alt = 'uploaded image';
            img.className = 'preview';
            img.style.maxWidth = '420px';
            img.style.borderRadius = '6px';
            img.style.display = 'block';

            preview.appendChild(a);
            preview.appendChild(img);

            status.innerHTML = `อัพโหลดเสร็จ — <a href="${url}" target="_blank" rel="noopener">เปิดภาพ</a>`;
            showSwalSuccess('อัพโหลดเสร็จ', `เปิดภาพ: <a href="${url}" target="_blank" rel="noopener">${url}</a>`);
          } else {
            // no url returned — still show local saved path if any and keep previous local preview
            status.textContent = 'อัพโหลดเสร็จ แต่เซิร์ฟเวอร์ไม่ได้ส่ง url กลับ';
            if (localPath) {
              const p = document.createElement('div');
              p.innerHTML = `ไฟล์ถูกบันทึกที่: <code>${localPath}</code>`;
              preview.appendChild(p);
            }
            showSwalSuccess('อัพโหลดเสร็จ', 'เซิร์ฟเวอร์ตอบกลับสำเร็จ แต่ไม่มีลิงก์รูป');
          }

          // cleanup input and objectUrl (if used)
          if (objectUrl) {
            URL.revokeObjectURL(objectUrl);
            objectUrl = null;
          }
          input.value = '';
        } catch (err) {
          console.error('upload error', err);
          status.textContent = 'Error: ' + (err.message || err);
          showSwalError('เกิดข้อผิดพลาด', err instanceof Error ? err.message : String(err));
        } finally {
          uploadBtn.disabled = false;
        }
      });
    })();
  </script>
</body>

</html>